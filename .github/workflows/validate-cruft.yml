name: Validate Cruft Status

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  validate-cruft:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install cruft
        run: pip install cruft

      - name: Check for manual .cruft.json edits
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        run: |
          if git diff HEAD^ HEAD --name-only | grep -q '\.cruft\.json'; then
            # .cruft.json was changed
            changed_files=$(git diff HEAD^ HEAD --name-only | wc -l)
            cruft_only=$(git diff HEAD^ HEAD --name-only | grep -c '\.cruft\.json' || true)

            if [ "$changed_files" -eq 1 ] && [ "$cruft_only" -eq 1 ]; then
              echo "❌ ERROR: Only .cruft.json was modified"
              echo ""
              echo "This suggests manual editing instead of running 'cruft update'."
              echo ""
              echo "To fix:"
              echo "  1. Revert the manual edit: git checkout HEAD^ -- .cruft.json"
              echo "  2. Run: cruft update"
              echo "  3. Review changes: git diff"
              echo "  4. Commit if successful: git add . && git commit -m 'chore: update from template'"
              exit 1
            fi
          fi

      - name: Verify cruft status
        run: |
          echo "Checking if project is in sync with template..."
          if cruft check; then
            echo "✅ Project is up to date with template"
          else
            echo "⚠️  Project is out of sync with template"
            echo ""
            echo "To update:"
            echo "  cruft diff   # Preview changes"
            echo "  cruft update # Apply changes"
            echo ""
            # Don't fail on scheduled runs or manual triggers (just warn)
            if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "Creating an issue to track this..."
              exit 0
            else
              echo "Failing CI to prevent merging out-of-date code"
              exit 1
            fi
          fi

      - name: Show template diff (if out of sync)
        if: failure()
        run: |
          echo "Template changes that need to be applied:"
          cruft diff || true
